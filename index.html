<!doctype html>
<html lang="en">
<head>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Nutrition for Learning Project</title>

    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600" rel="stylesheet">
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">

    <link href="https://api.tiles.mapbox.com/mapbox.js/v2.2.3/mapbox.css" rel="stylesheet">
    <link href="https://api.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/MarkerCluster.css" rel="stylesheet">
    <link href="https://api.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/MarkerCluster.Default.css" rel="stylesheet">

    <link href="offcanvas.css" rel="stylesheet">

    <style>
      /* make the map full height */
      html, body, main, .row, #map, #sidebar {
        height: 100%;
      }

      /* bootstrap.css sets font-family for these */
      body, .tooltip, .popover {
        font-family: "Source Sans Pro";
      }

      /* .navbar min-height */
      body {
        padding-top: 50px;
      }

      /* use h1 in the navbar */
      h1 {
        margin: 0;
        font-weight: 600;
      }

      /* no padding in the sidebar */
      #sidebar {
        padding-right: inherit;
        padding-left: inherit;
        overflow: auto;
      }

      /* list-group tweaks */
      .list-group-item:first-child {
        border-top-left-radius: 0;
        border-top-right-radius: 0;
      }

      .list-group-item:last-child {
        border-bottom-left-radius: 0;
        border-bottom-right-radius: 0;
      }
      
      div.tab-pane {
        padding-top: 1em;
      }

      /* Marker cluster colours */
      .marker-cluster-small {
        background-color: rgba(189, 215, 231, 0.6);
      }
      .marker-cluster-small div {
        background-color: rgba(107, 174, 214, 0.6);
      }
      .marker-cluster-medium,
      .marker-cluster-large {
        background-color: rgba(189, 215, 231, 0.6);
      }
      .marker-cluster-medium div,
      .marker-cluster-large div {
        background-color: rgba(239,243,255, 0.6);
      }
      
      /* Map Legend */
      div.legend {
        height: 1em;
      }
      div.legend i {
        width: 2em;
        height: 1em;
        float: left;
      }
      
    </style>
  </head>

  <body>
    <header class="navbar navbar-inverse navbar-fixed-top">
      <nav class="container-fluid" role="navigation">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse" aria-expanded="false">
              <span class="sr-only">Navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <h1 class="navbar-brand">Nutrition for Learning</h1>
          </div> <!--navbar-header-->

          <div class="navbar-collapse collapse" id="navbar-collapse">
            <ul class="nav navbar-nav navbar-right">
              <li>
                <a href="#" class="navbar-link" data-toggle="modal" data-target="#glossary-modal">
                  Glossary
                </a>
              </li>
              <li class="visible-xs">
                <a href="#" data-toggle="offcanvas">List of Schools</a>
              </li>
            </ul>
          </div><!--navbar-collapse-->
      </nav>
    </header>

    <main class="container-fluid">
      <div class="row row-offcanvas row-offcanvas-left">
        <div class="col-xs-6 col-sm-3 sidebar-offcanvas" id="sidebar">

          <!--school list-->
          <ul class="list-group" id="school-list"></ul>

        </div> <!--sidebar-->
        <div class="col-xs-12 col-sm-9" id="map"></div>
      </div> <!--row-->
    </main>

    <div class="modal fade" id="school-modal" tabindex="-1" role="dialog">
      <div class="modal-dialog">
        <div class="modal-content" id="modal-content"></div>
      </div>
    </div><!--school-modal-->

    <div class="modal fade" id="glossary-modal" tabindex="-1" role="dialog">
      <div class="modal-dialog">
        <div class="modal-content" id="modal-content">
          <div class="modal-header">
            <button class="close" type="button" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h3 class="modal-title text-primary">Glossary</h3>
          </div>
          <div class="modal-body">
            <ul class="nav nav-tabs" role="tablist">
              <li role="presentation" class="active">
                <a href="#summary-glossary" aria-controls="summary" role="tab" data-toggle="tab">Summary</a>
              </li>
              <li role="presentation">
                <a href="#programs-glossary" aria-controls="programs" role="tab" data-toggle="tab">Programs</a>
              </li>
              <li role="presentation">
                <a href="#school-glossary" aria-controls="school" role="tab" data-toggle="tab">School Profile</a>
              </li>
              <li role="presentation">
                <a href="#neighbourhood-glossary" aria-controls="neighbourhood" role="tab" data-toggle="tab">Neighbourhood</a>
              </li>
              <li role="presentation">
                <a href="#needs-glossary" aria-controls="needs" role="tab" data-toggle="tab">Needs</a>
              </li>
            </ul>
            <div class="tab-content">
              <div role="tabpanel" class="tab-pane active" id="summary-glossary">
                <h4>School Summary</h4>
                <dl>
                  <dt>Enrolment</dt>
                  <dd>Total enrolment of the school (using the most recent Nutrition for Learning numbers where possible, but in instances when they were unavailable, the figures from the Ministry of Education were used).</dd>

                  <dt>Students accessing Nutrition for Learning</dt>
                  <dd>The number and percentage of students accessing at least 1 Nutrition for Learning Program at the school.</dd>

                  <dt>Below median on achievement tests</dt>
                  <dd>% of Grade 3 and 6 or Grade 9 and 10 tests where the school ranked in the bottom half for % of students achieving provincial standard (or passing the test on their first attempt, for the Grade 10 Literacy test).</dd>

                  <dt>Students bused to school</dt>
                  <dd>The number and percentage of students transported to school by bus.</dd>

                  <dt>Parents with university education</dt>
                  <dd>The estimated percentage of children who attend the school and who have at least one parent whose highest certificate, diploma or degree is from a university. This is calculated using postal code data collected by the school and cross-referenced with Statistics Canada data about education from the 2006 Census.</dd>

                  <dt>Students from low income families</dt>
                  <dd>The estimated percentage of children who attend the school and whose families devote a larger share of income to basic necessities – food, shelter and clothing – than the average family. This is calculated using postal code data collected by the school and cross-referenced with Statistics Canada data about income from the 2006 Census.</dd>

                  <dt>Non-English newcomer students</dt>
                  <dd>% of students who are new to Canada from a non-English speaking country</dd>
                </dl>

                <h4>Neighbourhood Summary</h4>
                <dl>
                <dt>Population 0-19</dt>
                <dd>The population of the census planning district that is 0 to 19 years old (2011 census data).
                </dd>
                <dt>Census families with children</dt>
                <dd>Total number of married couples with children, common-law couples with children, and lone-parent families in the census planning district (2011 census data).
                </dd>
                <dt>Single parent families</dt>
                <dd>The number and percentage of lone-parent families in the census planning district (2011 census data; percentage of census families with children).
                </dd>
                <dt>Non-English at home</dt>
                <dd>Population (number and percentage) of the census planning district who do not speak English as one of their main languages at home (2011 census data).
                </dd>
                <dt>Occupied dwellings</dt>
                <dd>The total number of occupied dwellings in the census planning district (2011 census data).
                </dd>
                <dt>Non-single-detached homes</dt>
                <dd>The number and percentage of occupied dwellings in the census planning district that are not single-detached houses.
                </dd>
                </dl>
              </div>
              <div role="tabpanel" class="tab-pane active" id="programs-glossary">
                <dl>
                <dt>Program</dt>
                <dd>Nutrition for Learning program offered (e.g. breakfast, lunch, snack)
                </dd>
                <dt>Pop.</dt>
                <dd>Total enrolment of the school
                </dd>
                <dt>Avg.</dt>
                <dd>Average number of students per day that the program serves
                </dd>
                <dt>Unique</dt>
                <dd>Total number of students accessing the program per year
                </dd>
                <dt>Days</dt>
                <dd>Number of days per week that the program runs
                </dd>
                <dt>Weeks</dt>
                <dd>Number of weeks per year that the program operates
                </dd>
                </dl>
              </div>
              <div role="tabpanel" class="tab-pane active" id="school-glossary">
                <dl>
                <dt>First language is not English</dt>
                <dd>The percentage of the student population whose first spoken language is not English.
                </dd>
                <dt>First language is not French</dt>
                <dd>The percentage of the student population whose first spoken language is not French.
                </dd>
                <dt>Non English speaking newcomers</dt>
                <dd>% of students who are new to Canada from a non-English speaking country
                </dd>
                <dt>Non French speaking newcomers</dt>
                <dd>% of students who are new to Canada from a non-French speaking country
                </dd>
                <dt>Special education students</dt>
                <dd>The percentage of the student population who are in special education programs or receive special education services. This includes students with identified and non-identified exceptionalities, but excludes students identified as gifted.
                </dd>
                <dt>Parents with university education</dt>
                <dd>The estimated percentage of children who attend the school and who have at least one parent whose highest certificate, diploma or degree is from a university. This is calculated using postal code data collected by the school and cross-referenced with Statistics Canada data about education from the 2006 Census.
                </dd>
                <dt>Low income families</dt>
                <dd>The estimated percentage of children who attend the school and whose families devote a larger share of income to basic necessities – food, shelter and clothing – than the average family. This is calculated using postal code data collected by the school and cross-referenced with Statistics Canada data about income from the 2006 Census.
                </dd>
                <dt>Achievement - Grades 3, 6 and 9</dt>
                <dd>The percentage of students in the specified grade who met or exceeded the provincial standard on the Education Quality and Accountability Office (EQAO) test in the specified year. The provincial standard is equivalent to a “B.”
                </dd>
                <dt>Achievement - Grade 10</dt>
                <dd>The percentage of students who passed the Ontario Secondary School Literacy Test (OSSLT) on their first attempt when they were in Grade 10.
                </dd>
                </dl>
              </div>
              <div role="tabpanel" class="tab-pane active" id="neighbourhood-glossary">
                <dl>
                  <dt>Population (2011)</dt>
                  <dd>Total population of the census planning district (2011 census data)
                  </dd>
                  <dt>Children 0-4</dt>
                  <dd>Total number of children in the census planning district aged 0 to 4 (2011 census data)
                  </dd>
                  <dt>Children 5-9</dt>
                  <dd>Total number of children in the census planning district aged 5 to 9 (2011 census data)
                  </dd>
                  <dt>Children 10-14</dt>
                  <dd>Total number of children in the census planning district aged 10 to 14 (2011 census data)
                  </dd>
                  <dt>Youth 15-19</dt>
                  <dd>Total number of youth in the census planning district aged 15 to 19 (2011 census data)
                  </dd>
                  <dt>Social cohesion</dt>
                  <dd>Based on the percentage of families experiencing social cohesion, defined as scoring at least a 7 (out of 10) on the Neighbourhood Social Cohesion Index. Gathered from the Kindergarten Parent Survey (2010), and calculated using a larger neighbourhood boundary than the census planning districts.
                  </dd>
                  <dt>Disposable income</dt>
                  <dd>Based on the percentage of families without disposable income. Gathered from the Kindergarten Parent Survey (2010), and calculated using a larger neighbourhood boundary than the census planning districts.
                  </dd>
                  <dt>Early Development Instrument</dt>
                  <dd>Based on the percentage of children scoring low on two or more domains of the Early Development Instrument (2010); calculated using a larger neighbourhood boundary than the census planning districts.
                  </dd>
                  <dt>Infants at Risk</dt>
                  <dd>Based on the percentage of infants screened with potential risk on the Healthy Babies Healthy Children Screen in 2013; calculated using a larger neighbourhood boundary than the census planning districts.
                  </dd>
                </dl>
              </div>
              <div role="tabpanel" class="tab-pane active" id="needs-glossary">
                <h4>School Need Index</h4>
                <p>The index was created based on consideration of six variables indicative of the degree of need of a school. The following data was available for most schools, with the figures based on the percentage of total enrolment for each school.</p>
                <ul>
                <li>% of students who have accessed a Nutrition for Learning program (low % indicating need)</li>
                <li>% of students bused to school (high % indicating need)</li>
                <li>% of students living in low-income households (high % indicating need)</li>
                <li>% of students whose parents have some university education (low % indicating need)</li>
                <li>% of students new to Canada from non-English households (high % indicating need)</li>
                <li>% achieving the provincial standard on EQAO testing (low % indicating need)</li>
                </ul>
                <h4>District Need Index</h4>
                <p>The index was created based on consideration of four variables indicative of the degree of need of a neighbourhood:</p>
                <ul>
                <li>% of the total population in 2011 that is 0-19 years old (high % indicating need)</li>
                <li>% of single-parent families, out of total census families (high % indicating need)</li>
                <li>% of dwelling that are not single-detached houses (high % indicating need)</li>
                <li>% of the population for which English is not one of the languages spoken most often at home (high % indicating need)</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div><!--glossary-modal-->

    <!-- Javascripts -->
    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.5/handlebars.min.js"></script>

    <script src="https://api.tiles.mapbox.com/mapbox.js/v2.2.3/mapbox.js"></script>
    <script src="https://api.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/leaflet.markercluster.js"></script>
    <script src="leaflet/Leaflet.MakiMarkers.js"></script>

    <script src="offcanvas.js"></script>

    <!-- Data -->
    <script src="schools.js"></script>
    <script src="programs.js"></script>
    <script src="districts-geo.js"></script>
    <script src="district-needs.js"></script>
    <script src="districts.js"></script>
    <script src="school-summary.js"></script>
    <script src="school-needs.js"></script>
    <script src="neighbourhood-summary.js"></script>

    <!-- Templates -->
    <script type="text/template" id="school-list-item">
      <li class="list-group-item" id="{{layerId}}" data-lat="{{lat}}" data-lng="{{lng}}">
        <h5 class="list-group-item-heading feature-name">
          {{schoolName}}
          <small><br>{{schoolCity}} ({{district.Name}})</small>
        </h5>
      </li>
    </script>

    <script type="text/template" id="school-modal-content">
      <div class="modal-header">
        <button class="close" type="button" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3 class="modal-title text-primary" id="feature-title">{{schoolName}}</h3>
        <p>{{schoolAddress}}, {{schoolCity}}</p>
      </div>
      <div class="modal-body" id="feature-info">
        <ul class="nav nav-tabs" role="tablist">
          <li role="presentation" class="active">
            <a href="#summary" aria-controls="summary" role="tab" data-toggle="tab">Summary</a>
          </li>
          {{#if programs}}
          <li role="presentation">
          {{else}}
          <li role="presentation" class="disabled">
          {{/if}}
            <a href="#programs" aria-controls="programs" role="tab" data-toggle="tab">Programs</a>
          </li>
          <li role="presentation">
            <a href="#school" aria-controls="school" role="tab" data-toggle="tab">School Profile</a>
          </li>
          <li role="presentation">
            <a href="#neighbourhood" aria-controls="neighbourhood" role="tab" data-toggle="tab">Neighbourhood</a>
          </li>
        </ul>
        <div class="tab-content">
          <div role="tabpanel" class="tab-pane active" id="summary">
            {{#with school_summary}}
            <h4>School Summary</h4>
            <div class="table-responsive">
              <table class="table">
                <tbody>
                  <tr>
                    <th>Enrolment</th>
                    <td>{{enrolment}}</td>
                  </tr>
                  <tr>
                    <th>Students accessing Nutrition for Learning</th>
                    <td>{{num_unique}} ({{per_accessing}}%)</td>
                  </tr>
                  <tr>
                    <th>Below median on achievement tests</th>
                    <td>{{per_achieve}}%</td>
                  </tr>
                  <tr>
                    <th>Students bused to school</th>
                    <td>{{num_transported}} ({{per_transported}}%)</td>
                  </tr>
                  <tr>
                    <th>Parents with university education</th>
                    <td>{{university}}</td>
                  </tr>
                  <tr>
                    <th>Students from low income families</th>
                    <td>{{low_income}}</td>
                  </tr>
                  <tr>
                    <th>Non-English newcomer students</th>
                    <td>{{non_english_newcomers}}</td>
                  </tr>
                </tbody>
              </table>
            </div>
            {{/with}}

            {{#with neighbourhood_summary}}
            <h4>Neighbourhood Summary</h4>
            <div class="table-responsive">
              <table class="table">
                <tbody>
                  <tr>
                    <th>Population 0-19</th>
                    <td>{{population}} ({{percent}}%)</td>
                  </tr>
                  <tr>
                    <th>Census families with children</th>
                    <td>{{families}}</td>
                  </tr>
                  <tr>
                    <th>Single parent families</th>
                    <td>{{single_parent}} ({{single_parents}}%)</td>
                  </tr>
                  <tr>
                    <th>Non-English at home</th>
                    <td>{{not_english}} ({{per_not_english}}%)</td>
                  </tr>
                  <tr>
                    <th>Occupied dwellings</th>
                    <td>{{dwellings}}</td>
                  </tr>
                  <tr>
                    <th>Non-single-detached homes</th>
                    <td>{{non_semi_detached}} ({{per_non_single_detached}}%)</td>
                  </tr>
                </tbody>
              </table>
            </div>
            {{/with}}
          </div>

          <div role="tabpanel" class="tab-pane" id="programs">
            {{#if programs}}
              {{#each programs}}
            <div class="table-responsive">
              <table class="table table-bordered">
                <caption><h4>{{name}}</h4></caption>
                <thead>
                  <th>Program</th>
                  <th>Pop.</th>
                  <th>Avg.</th>
                  <th>Unique</th>
                  <th>Days</th>
                  <th>Weeks</th>
                </thead>
                <tbody>
                <td>
                  {{programs}}
                  {{#if designation}}({{designation}}){{/if}}</td>
                <td>{{pop}}</td>
                <td>{{average}}</td>
                <td>{{unique}}</td>
                <td>{{days}}</td>
                <td>{{weeks}}</td>
                </tbody>
              </table>
            </div>
              {{/each}}
            {{else}}
            <h5>No programs at this site.</h5>
            {{/if}}
          </div>
          <div role="tabpanel" class="tab-pane" id="school">
          {{#with properties}}
            <div class="table-responsive">
              <table class="table">
                <tbody>
                  <tr><th>Level</th><td>{{level}}</td></tr>
                  <tr><th>Grade Range</th><td>{{grades}}</td></tr>
                  {{#if conditions}}
                  <tr><th>Special Conditions Code</th><td>{{conditions}}</td></tr>
                  {{/if}}
                  <tr><th>Board</th><td>{{board}}</td></tr>
                  <tr><th>Enrolment</th><td>{{enrolment}}</td></tr>
                  <tr><th>Language</th><td>{{language}}</td></tr>
                  {{#each languages}}
                  <tr><th>{{@key}}</th><td>{{this}}</td></tr>
                  {{/each}}
                  {{#if gifted}}
                  <tr><th>Gifted</th><td>{{gifted}}</td></tr>
                  {{/if}}
                  {{#if special}}
                  <tr><th>Special education students</th><td>{{special}}</td></tr>
                  {{/if}}
                  {{#if university}}
                  <tr><th>Parents with university education</th><td>{{university}}</td></tr>
                  {{/if}}
                  {{#if low_income}}
                  <tr><th>Low income families</th><td>{{low_income}}</td></tr>
                  {{/if}}
                  {{#if website}}
                  <tr><th>Website</th><td><a href="{{website}}">{{website}}</a></td></tr>
                  {{/if}}
                  <tr><th>Opened</th><td>{{opened}}</td></tr>
                </tbody>
              </table>
            </div>
          {{/with}}
          {{#if achievements}}
            <h4>Achievements</h4>
            <p>Percentage of students achieving provincial standard</p>
            <div class="table-responsive">
              <table class="table">
                <tbody>
              {{#each achievements}}
                   <tr><th>{{@key}}</th><td>{{this}}</td></tr>
              {{/each}}
                <tbody>
              </table>
            </div>
          {{/if}}
          </div>
          <div role="tabpanel" class="tab-pane" id="neighbourhood">
            {{#with district}}
            <h4>{{Name}} ({{Municipality}})</h4>
            <div class="table-responsive">
              <table class="table">
                <tbody>
                  <tr><th>Population (2011)</th><td>{{Pop2011}}</td></tr>
                  <tr><th>Children 0-4</th><td>{{Pop04}} ({{Percent04}}%)</td></tr>
                  <tr><th>Children 5-9</th><td>{{Pop59}} ({{Percent59}}%)</td></tr>
                  <tr><th>Children 10-14</th><td>{{Pop1014}} ({{Percent1014}}%)</td></tr>
                  <tr><th>Youth 15-19</th><td>{{Pop1519}} ({{Percent1519}}%)</td></tr>
                </tbody>
              </table>
            </div>
            {{/with}}

            {{#with neighbourhood}}
              <h4>{{neighbourhood}}</h4>
              <ul class="list-group">
                {{#if social_cohesion}}
                <li class="list-group-item"><strong>{{social_cohesion}}%</strong> of families experience <strong>low social cohesion</strong></li>
                {{/if}}

                {{#if disposable_income}}
                <li class="list-group-item"><strong>{{disposable_income}}</strong> % of families <strong>without disposable income</strong></li>
                {{/if}}

                {{#if early_development}}
                <li class="list-group-item"><strong>{{early_development}}</strong> % of children <strong>scoring low in the Early Development Instrument</strong></li>
                {{/if}}

                {{#if infants_at_risk}}
                <li class="list-group-item"><strong>{{infants_at_risk}}</strong> % of <strong>infants at risk</strong></li>
                {{/if}}
              </ul>
            {{/with}}
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
      </li>
    </script>

    <script type="text/template" id="legend">
      <ul class="list-group">
        <li class="list-group-item">
          <h5 class="list-group-item-heading">
            School Need Index<small><br>Lowest to Highest Need</small>
          </h5>
          <div class="list-group-item-text legend">
            <i style="background:#ffffb2;"></i>
            <i style="background:#fed976;"></i>
            <i style="background:#feb24c;"></i>
            <i style="background:#fd8d3c;"></i>
            <i style="background:#f03b20;"></i>
            <i style="background:#bd0026;"></i>
          </div>
        </li>
        <li class="list-group-item">
          <h5 class="list-group-item-heading">
            District Need Index<small><br>Lowest to Highest Need</small>
          </h5>
          <div class="list-group-item-text legend">
            <i style="background:#bae4b3;"></i>
            <i style="background:#74c476;"></i>
            <i style="background:#31a354;"></i>
            <i style="background:#006d2c;"></i>
          </div>
        </li>
      </ul>
    </script>


    <!-- Handlebars -->
    <script>
      var template = function(elementId) {
        return Handlebars.compile(document.getElementById(elementId).innerHTML);
      }
      var listTemplate = template("school-list-item");
      var modalTemplate = template("school-modal-content");
      var legendTemplate = template("legend");
    </script>


    <!-- School data from geojson features -->
    <script>
      var na_to_null = function(val) {
        if (val.toString().toLowerCase() == "na") {
          return null;
        } else if (val.toString().toLowerCase() == "not applicable") {
          return null;
        } else {
          return val;
        }
      }
      var grades = function(r) {
        switch (r) {
          case "01/08/2015": return "1-8";
          case "05/08/2015": return "5-8";
          case "06/08/2015": return "6-8";
          case "07/08/2015": return "7-8";
          case "07/12/2015": return "7-12";
          case "09/12/2015": return "9-12";
          default: return r;
        }
      }
      var rank = function(indicator) {
        switch (indicator) {
          case 4: return "Highest";
          case 3: return "Higher";
          case 2: return "Lower";
          case 1: return "Lowest";
          default: return null;
        }
      }
      var rankings = function(neighbourhood) {
        return {
          "neighbourhood": neighbourhood["Neighbourhood"],
          "disposable_income": rank(neighbourhood["Disposable Income"]),
          "early_development": rank(neighbourhood["Early Development"]),
          "infants_at_risk": rank(neighbourhood["Infants at Risk"]),
          "social_cohesion": na_to_null(neighbourhood["Low Social Cohesion"])
        }
      }
      var languages = function(props) {
        if (props["School Language"] == "French") {
          return {
            "First language is not French": props["not_french"],
            "Non French speaking newcomers": props["non_french_newcomers"]
          }
        } else {
          return {
            "First language is not English": props["not_english"],
            "Non English speaking newcomers": props["non_english_newcomers"]
          }
        }
      }
      var schoolData = function(layer) {
        var prop = layer.feature.properties;
        var achievements = function(school) {
          switch (school["School Level"]) {
            case "Elementary": return {
              "Grade 3 Math": school["grade_3_math"],
              "Grade 3 Reading": school["grade_3_reading"],
              "Grade 3 Writing": school["grade_3_writing"],
              "Grade 6 Math": school["grade_6_math"],
              "Grade 6 Reading": school["grade_6_reading"],
              "Grade 6 Writing": school["grade_6_writing"]
            };
            case "Secondary": return {
              "Grade 9 Academic": school["grade_9_academic"],
              "Grade 9 Applied": school["grade_9_applied"],
              "Grade 10 Literacy": school["grade_10_literacy"]
            };
            default: return null;
          }
        }
        var data = {
          "layerId": L.stamp(layer),
          "lat": layer.getLatLng().lat,
          "lng": layer.getLatLng().lng,
          "schoolName": prop["School Name"],
          "schoolAddress": prop["Street"],
          "schoolCity": prop["City"],
          "schoolId": layer.feature.id,
          "programs": programs[layer.feature.id],
          "district": districts[prop["district"]],
          "need": school_needs[layer.feature.id],
          "achievements": achievements(prop),
          "school_summary": school_summary[layer.feature.id],
          "neighbourhood": rankings(prop["neighbourhood"]),
          "neighbourhood_summary": neighbourhood_summary[prop["district"]],
          "properties": {
            "board": prop["Board Name"],
            "opened": new Date(prop["Date Open"]).getFullYear(),
            "enrolment": prop["Enrolment"],
            "grades": grades(prop["Grade Range"]),
            "language": prop["School Language"],
            "languages": languages(prop),
            "level": prop["School Level"],
            "conditions": na_to_null(prop["School Special Conditions Code"]),
            "gifted": na_to_null(prop["gifted"]),
            "special": na_to_null(prop["special_education"]),
            "university": na_to_null(prop["university_education"]),
            "website": prop["website"],
            "low_income": na_to_null(prop["low_income"])
          }
        }
        return data;
      }
    </script>


    <!-- CSS functions -->
    <script>
      // remove a class from an element, eg, "active"
      var removeClass = function(className) {
        return function (element) {
          element.classList.remove(className);
        }
      }
      var removeActive = removeClass("active");

      // get an array of tagName in an element, eg, <li> in <ul>
      var tagArray = function(tagName) {
        return function (element) {
          var elementCollection = element.getElementsByTagName(tagName);
          return Array.prototype.slice.call(elementCollection);
        }
      }
      var listArray = tagArray("li");
    </script>


    <!-- Map setup -->
    <script>
      L.mapbox.accessToken = "pk.eyJ1IjoidG9kZHR1cm5idWxsIiwiYSI6IlVxTDhQT0EifQ.h5dUJmmsLh_zQ7hZQJjBbg";
      var m = {
        "id": "mapbox.streets",
        "centre": [43.43,-80.46],
        "zoom": 11
      };

      clusterOptions = {
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        zoomToBoundsOnClick: true,
        disableClusteringAtZoom: 14,
        maxClusterRadius: 30
      }
    </script>


    <!-- Mapping -->
    <script>
      var map = L.mapbox.map("map", m.id).setView(m.centre, m.zoom);

      var markerClusters = new L.MarkerClusterGroup(clusterOptions);
      map.addLayer(markerClusters);

      var circleHighlight = L.circle([0,0], 50, {
        color: "#a50f15",
        fillColor: "#a50f15",
        fillOpacity: 0.5
      }).addTo(map);

      var schoolList = document.getElementById("school-list"); // sidebar

      var schoolColour = function(need) {
        switch (need) {
          case "1": return "#ffffb2";
          case "2": return "#fed976";
          case "3": return "#feb24c";
          case "4": return "#fd8d3c";
          case "5": return "#f03b20";
          case "6": return "#bd0026";
          default: return "#ccc";
        }
      }

      var schoolIcon = function(id) {
        if (programs[id] == null) {
          return "circle-stroked";
        } else {
          return "restaurant";
        }
      }
      var schoolMarkers = L.geoJson(null, {
        onEachFeature: function (feature, layer) {
          if (feature.properties) {
            var data = schoolData(layer);

            layer.on({
              click: function (e) {
                document.getElementById("modal-content").innerHTML = modalTemplate(data);
                circleHighlight.setLatLng(layer.getLatLng())
                $("#school-modal").modal("show"); // seems to need JQuery to work
              }
            });

            $("#school-list").append(listTemplate(data)); // easier with JQuery
            document.getElementById(data.layerId).onclick = function clickSchool() {
              // Clicking on a school name sets it to "active"
              listArray(schoolList).forEach(removeActive);
              this.classList.add("active");
              map.setView(layer.getLatLng(), 15);
              circleHighlight.setLatLng(layer.getLatLng());
            }
          }
        },
        pointToLayer: function (feature, latlng) {
          var colour = schoolColour(school_needs[feature.id]);
          var icon = L.MakiMarkers.icon({icon: schoolIcon(feature.id), color: colour, size: "m"});
          return L.marker(latlng, {icon: icon});
        }
      });

      schoolMarkers.addData(schools);
      //map.addLayer(schoolsLayer);
      markerClusters.addLayer(schoolMarkers);

      var districtColour = function(need) {
        switch (need) {
          case "1": return "#bae4b3";
          case "2": return "#74c476";
          case "3": return "#31a354";
          case "4": return "#006d2c";
          default: return "#ccc";
        }
      }

      var neighbourhoodsLayer = L.geoJson(
        shapes, {
          style: function (feature) {
            var need = district_needs[feature.id];
            return {
              color: "#999",
              weight: 1,
              fillColor: districtColour(need),
              fillOpacity: .6
            };
          }
        }
      );
      map.addLayer(neighbourhoodsLayer);

      var legend = L.control({position: "topright"});
      legend.onAdd = function (map) {
        var div = L.DomUtil.create("div", "info");
        div.innerHTML = legendTemplate();
        return div;
      };
      legend.addTo(map);

      map.on("moveend", function (e) {
        var bounds = map.getBounds();
        listArray(schoolList).forEach(function displaySchool(element) {
          var latlng = L.latLng(element.dataset.lat, element.dataset.lng)
          if(bounds.contains(latlng)) {
            element.style.display = "block";
          } else {
            element.style.display = "none";
          };
        });
      });

      // Set up markers and sidebar list
      /*
      var markerGroup = [];
      schools.features.forEach(function(feature) {
        var latlng = feature.geometry.coordinates.reverse();
        var marker = new L.marker(latlng);
        var props = feature.properties;
        marker.bindPopup(props["School Name"]);
        markerGroup.push({
          marker: marker
        });
      });
      */

    </script>
</body>
</html>
